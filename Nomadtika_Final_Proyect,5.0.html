<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nomadtika App v4.6 (Full + Skill Filters)</title>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

:root {
    --primary: #111827;      
    --accent: #009B77;       
    --accent-hover: #007a5e;
    --bg: #FFFFFF;           
    --bg-alt: #F9FAFB;       
    --border: #E5E7EB;
    --text: #374151;
    --text-light: #6B7280;
    --danger: #EF4444;
    --danger-dark: #991B1B;
    --success: #10B981;
    --info: #3B82F6;
    --warning: #F59E0B;
    --priority: #000000; /* Color Prioridad Nomadtika */
    
    --radius: 8px;
    --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    --font-main: 'Inter', system-ui, sans-serif;
    --font-mono: 'JetBrains Mono', monospace;
}

* { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
}

body {
    font-family: var(--font-main);
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    overflow: hidden;
}

.app-container { 
    display: flex; 
    width: 100%; 
    height: 100%; 
}

.sidebar {
    width: 260px;
    background: #F3F4F6;
    border-right: 1px solid var(--border);
    padding: 24px;
    display: flex; 
    flex-direction: column; 
    justify-content: space-between;
    flex-shrink: 0;
    transition: transform 0.3s ease;
}

.brand {
    font-size: 1.25rem; 
    font-weight: 800; 
    color: var(--primary); 
    margin-bottom: 40px;
    display: flex; 
    align-items: center; 
    gap: 10px; 
    letter-spacing: -0.02em;
}
.brand span { color: var(--accent); }

.nav-menu { 
    display: flex; 
    flex-direction: column; 
    gap: 6px; 
}

.nav-item {
    background: transparent; 
    border: none; 
    text-align: left; 
    padding: 12px 16px;
    border-radius: var(--radius); 
    color: var(--text-light); 
    font-weight: 500;
    font-size: 0.9rem; 
    cursor: pointer; 
    transition: all 0.2s;
    display: flex; 
    align-items: center; 
    gap: 12px;
}
.nav-item:hover:not(.locked) { background: #E5E7EB; color: var(--primary); }
.nav-item.active { background: var(--primary); color: #fff; box-shadow: var(--shadow); }
.nav-item.locked { opacity: 0.5; cursor: not-allowed; }

.mobile-header {
    display: none;
    background: var(--primary);
    color: #fff;
    padding: 16px 20px;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 50;
}

.menu-toggle {
    background: none;
    border: none;
    color: #fff;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 8px;
}

.mobile-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 98;
}
.mobile-overlay.active {
    display: block;
}

.main-content {
    flex: 1; 
    padding: 40px; 
    overflow-y: auto; 
    background: var(--bg); 
    position: relative;
}

h2 { 
    font-size: 1.8rem; 
    font-weight: 700; 
    color: var(--primary); 
    margin-bottom: 24px; 
    letter-spacing: -0.02em; 
}

h3 { 
    font-size: 1rem; 
    font-weight: 600; 
    color: var(--primary); 
    margin-bottom: 16px; 
    text-transform: uppercase; 
    letter-spacing: 0.05em; 
}

.card {
    background: #fff; 
    border: 1px solid var(--border); 
    border-radius: 12px;
    padding: 24px; 
    margin-bottom: 24px; 
    box-shadow: var(--shadow);
}

.card-header-flex { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 16px; 
    flex-wrap: wrap; 
    gap: 10px; 
}

.chart-select { 
    padding: 6px 12px; 
    border: 1px solid var(--border); 
    border-radius: 6px; 
    font-size: 0.85rem; 
    color: var(--text); 
    background: var(--bg-alt); 
    cursor: pointer; 
}

.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-group.full { grid-column: 1 / -1; }

label { font-size: 0.85rem; font-weight: 600; color: var(--text); }

input, select, textarea {
    padding: 10px; 
    border: 1px solid var(--border); 
    border-radius: 6px;
    font-size: 0.9rem; 
    transition: 0.2s; 
    background: #fff; 
    font-family: var(--font-main);
}
input:focus, select:focus, textarea:focus { 
    border-color: var(--accent); 
    outline: none; 
    box-shadow: 0 0 0 3px rgba(0,155,119,0.1); 
}
input.error, select.error { border-color: var(--danger); }

.error-message {
    font-size: 0.75rem;
    color: var(--danger);
    margin-top: 4px;
}

.priority-toggle-container {
    background: #F3F4F6;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    border: 1px solid var(--border);
}
.priority-toggle-label {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--primary);
}

.material-search-container {
    position: relative;
}
.material-search-input {
    width: 100%;
    padding: 10px 36px 10px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.9rem;
    transition: 0.2s;
    background: #fff;
}
.material-search-input:focus {
    border-color: var(--accent);
    outline: none;
    box-shadow: 0 0 0 3px rgba(0,155,119,0.1);
}
.material-search-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
    pointer-events: none;
}
.material-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 6px;
    margin-top: 4px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 10;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}
.material-dropdown.show {
    display: block;
}
.material-category {
    position: sticky;
    top: 0;
    background: var(--bg-alt);
    padding: 8px 12px;
    font-weight: 700;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text);
    border-bottom: 1px solid var(--border);
    z-index: 2;
}
.material-option {
    padding: 10px 12px;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 0.9rem;
}
.material-option:hover {
    background: var(--bg-alt);
}
.material-option.selected {
    background: #ECFDF5;
    color: var(--accent);
    font-weight: 600;
}
.material-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    margin-left: 8px;
}
.material-wall { background: #DBEAFE; color: #1E40AF; }
.material-ceiling { background: #FEF3C7; color: #92400E; }
.material-screen { background: #F3E8FF; color: #6B21A8; }

.file-upload-wrapper {
    border: 2px dashed var(--border); 
    border-radius: 8px; 
    padding: 24px;
    text-align: center; 
    cursor: pointer; 
    transition: all 0.2s; 
    background: var(--bg-alt);
}
.file-upload-wrapper:hover { border-color: var(--accent); background: #F0FDF4; }
.file-name { margin-top: 8px; font-size: 0.85rem; color: var(--accent); font-weight: 600; }

.file-edit-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.file-current {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: var(--bg-alt);
    border: 1px solid var(--border);
    border-radius: 6px;
    flex-wrap: wrap;
    gap: 8px;
}
.file-current-name {
    font-weight: 600;
    font-size: 0.9rem;
    flex: 1;
    min-width: 150px;
}
.file-current-actions {
    display: flex;
    gap: 8px;
}
.file-upload-edit {
    border: 2px dashed var(--border);
    border-radius: 6px;
    padding: 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--bg-alt);
}
.file-upload-edit:hover {
    border-color: var(--accent);
    background: #F0FDF4;
}
.file-removed-indicator {
    padding: 8px 12px;
    background: #FEE2E2;
    border: 1px solid #FCA5A5;
    border-radius: 6px;
    color: #991B1B;
    font-size: 0.85rem;
    text-align: center;
}

.btn {
    padding: 10px 20px; 
    border-radius: 6px; 
    font-weight: 600; 
    font-size: 0.9rem;
    border: none; 
    cursor: pointer; 
    transition: 0.2s; 
    display: inline-flex;
    align-items: center; 
    justify-content: center; 
    gap: 8px;
}
.btn:active { transform: scale(0.98); }
.btn-primary { background: var(--primary); color: #fff; }
.btn-accent { background: var(--accent); color: #fff; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
.btn-outline:hover { border-color: var(--text); background: var(--bg-alt); }
.btn-danger { background: var(--danger); color: #fff; }
.btn-success { background: var(--success); color: #fff; }
.btn-warning { background: var(--warning); color: #fff; }
.btn-priority { background: #000; color: #fff; }
.btn-sm { padding: 6px 12px; font-size: 0.8rem; }

.search-filter-section {
    background: #fff; border: 1px solid var(--border); border-radius: 12px;
    padding: 20px; margin-bottom: 24px; box-shadow: var(--shadow);
}
.search-bar {
    position: relative;
    margin-bottom: 16px;
}
.search-input {
    width: 100%;
    padding: 12px 16px 12px 44px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 0.95rem;
    transition: all 0.2s;
    background: var(--bg-alt);
}
.search-input:focus {
    border-color: var(--accent);
    background: #fff;
    outline: none;
    box-shadow: 0 0 0 3px rgba(0,155,119,0.1);
}
.search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
    font-size: 1.2rem;
}
.filters-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: flex-end;
}
.filter-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
    min-width: 140px;
}
.filter-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}
.filter-select {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.85rem;
    background: #fff;
    cursor: pointer;
    transition: 0.2s;
    width: 100%;
}
.filter-select:hover {
    border-color: var(--accent);
}
.date-input {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.85rem;
    background: #fff;
    width: 100%;
}
.clear-filters-btn {
    padding: 8px 16px;
    background: var(--bg-alt);
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text);
    cursor: pointer;
    transition: 0.2s;
    white-space: nowrap;
}
.clear-filters-btn:hover {
    background: #fff;
    border-color: var(--text);
}
.results-count {
    font-size: 0.85rem;
    color: var(--text-light);
    font-weight: 500;
    padding: 8px 0;
}

.job-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px; border: 1px solid var(--border); border-radius: 8px;
    margin-bottom: 12px; background: #fff; transition: border-color 0.2s;
    gap: 16px;
}
.job-item:hover { border-color: var(--accent); }
.job-item-content {
    flex: 1;
    min-width: 0;
}
.job-item-actions {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
}
.job-status {
    display: inline-block; padding: 4px 10px; border-radius: 20px;
    font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
    margin-left: 8px;
}
.status-pending { background: #FFF7ED; color: #C2410C; }
.status-assigned { background: #ECFDF5; color: #047857; }
.status-complete { background: #374151; color: #F9FAFB; }
.status-priority { background: #000; color: #fff; }

.outsider-badge {
    display: inline-block; padding: 4px 10px; border-radius: 20px;
    font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
    background: #EDE9FE; color: #6B21A8; margin-left: 8px;
}
.assigned-worker {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
    color: var(--accent);
    font-weight: 600;
    margin-top: 4px;
}

.empty-state {
    text-align: center;
    padding: 60px 40px;
    color: var(--text-light);
}
.empty-state-icon {
    font-size: 3rem;
    margin-bottom: 16px;
    opacity: 0.5;
}
.empty-state-text {
    font-size: 1.1rem;
    font-weight: 500;
    margin-bottom: 8px;
}
.empty-state-subtext {
    font-size: 0.9rem;
    opacity: 0.7;
}

.installer-card {
    background: linear-gradient(135deg, var(--primary) 0%, #1F2937 100%);
    color: #fff; border-radius: 16px; padding: 40px; text-align: center;
    position: relative; overflow: hidden; display: flex; flex-direction: column;
    justify-content: center; align-items: center; min-height: 320px;
}
.installer-name { font-size: 3.5rem; font-weight: 800; margin: 10px 0; letter-spacing: -0.02em; }
.installer-meta { font-family: var(--font-mono); font-size: 0.9rem; opacity: 0.8; margin-bottom: 30px; }
.replacement-alert {
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; margin-bottom: 20px;
}

.filters-container { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
.filter-chip {
    padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border);
    background: #fff; font-size: 0.8rem; font-weight: 600; cursor: pointer;
    display: flex; align-items: center; gap: 6px; user-select: none; transition: 0.2s;
}
.filter-chip:hover { background: var(--bg-alt); }
.filter-chip.active { background: var(--primary); color: #fff; border-color: var(--primary); }
.chip-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}
.stat-card {
    background: linear-gradient(135deg, #fff 0%, #F9FAFB 100%);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
}
.stat-value {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 8px;
}
.stat-label {
    font-size: 0.85rem;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-top: 20px;
}
.calendar-header {
    text-align: center;
    font-weight: 700;
    padding: 12px;
    background: var(--bg-alt);
    border-radius: 6px;
    font-size: 0.85rem;
    color: var(--text);
}
.calendar-day {
    min-height: 100px;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px;
    background: #fff;
    position: relative;
}
.calendar-day-number {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-light);
    margin-bottom: 4px;
}
.calendar-event {
    background: var(--accent);
    color: #fff;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    margin-bottom: 4px;
    cursor: pointer;
    transition: 0.2s;
    line-height: 1.3;
}
.calendar-event:hover {
    background: var(--accent-hover);
}
.calendar-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 12px;
}
.calendar-month {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
}

.timeline-container {
    position: relative;
    padding: 20px 0;
}
.timeline-item {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    position: relative;
}
.timeline-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--accent);
    flex-shrink: 0;
    margin-top: 4px;
    position: relative;
    z-index: 2;
}
.timeline-line {
    position: absolute;
    left: 7px;
    top: 20px;
    bottom: -30px;
    width: 2px;
    background: var(--border);
}
.timeline-content {
    flex: 1;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
}
.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 8px;
    flex-wrap: wrap;
    gap: 8px;
}
.timeline-installer {
    font-weight: 700;
    color: var(--primary);
}
.timeline-response {
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 12px;
}
.response-yes {
    background: #ECFDF5;
    color: #047857;
}
.response-no {
    background: #FEE2E2;
    color: #991B1B;
}

.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 100; display: none;
    align-items: center; justify-content: center; backdrop-filter: blur(4px);
    padding: 20px;
}
.modal { 
    background: #fff; padding: 32px; border-radius: 16px; 
    width: 700px; max-width: 100%; max-height: 90vh; overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); 
}
.detail-row { 
    margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--bg-alt);
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}
.detail-row.full { grid-template-columns: 1fr; }
.detail-field {
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.detail-label { 
    font-size: 0.75rem; color: var(--text-light); 
    text-transform: uppercase; letter-spacing: 0.05em; 
}
.detail-content { 
    font-size: 1rem; font-weight: 500; color: var(--primary); word-break: break-word; 
}
.detail-input {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.9rem;
    font-family: var(--font-main);
}
.detail-input:focus {
    border-color: var(--accent);
    outline: none;
    box-shadow: 0 0 0 3px rgba(0,155,119,0.1);
}
.edit-mode-toggle {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-bottom: 16px;
}

.panel { display: none; animation: fadeIn 0.3s ease; }
.panel.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.toast {
    position: fixed; bottom: 30px; right: 30px; background: var(--primary); color: #fff;
    padding: 12px 24px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 1000;
}
.toast.show { transform: translateY(0); opacity: 1; }

.chart-container {
    position: relative;
    height: 350px;
    margin-bottom: 30px;
}

.time-filter-container {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}
.time-filter-btn {
    padding: 6px 16px;
    border: 1px solid var(--border);
    background: #fff;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}
.time-filter-btn:hover {
    background: var(--bg-alt);
}
.time-filter-btn.active {
    background: var(--primary);
    color: #fff;
    border-color: var(--primary);
}

.calendar-bottom-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-top: 24px;
}

.reassign-section {
    margin-top: 10px;
    padding: 16px;
    background: #FEF2F2;
    border: 1px solid #FCA5A5;
    border-radius: 8px;
    display: none;
}
.reassign-section.show { display: block; }

@media (max-width: 1024px) {
    .installer-card {
        padding: 30px 20px;
        min-height: 280px;
    }
    .installer-name {
        font-size: 2.5rem;
    }
}

@media (max-width: 768px) {
    body {
        flex-direction: column;
    }
    
    .mobile-header {
        display: flex;
    }
    
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 99;
        transform: translateX(-100%);
    }
    
    .sidebar.mobile-open {
        transform: translateX(0);
    }
    
    .main-content {
        padding: 20px;
        width: 100%;
    }
    
    h2 {
        font-size: 1.5rem;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .card {
        padding: 16px;
    }
    
    .search-filter-section {
        padding: 16px;
    }
    
    .filters-row {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .filter-group {
        width: 100%;
        min-width: auto;
    }
    
    .clear-filters-btn {
        width: 100%;
        margin-left: 0;
    }
    
    .job-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    .job-item-actions {
        width: 100%;
        justify-content: flex-end;
    }
    
    .calendar-grid {
        gap: 4px;
    }
    
    .calendar-day {
        min-height: 80px;
        padding: 4px;
    }
    
    .calendar-day-number {
        font-size: 0.75rem;
    }
    
    .calendar-event {
        font-size: 0.65rem;
        padding: 2px 4px;
    }
    
    .calendar-month {
        font-size: 1.2rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .stat-value {
        font-size: 2rem;
    }
    
    .installer-card {
        padding: 20px 16px;
        min-height: 240px;
    }
    
    .installer-name {
        font-size: 2rem;
    }
    
    .installer-meta {
        font-size: 0.8rem;
    }
    
    .modal {
        padding: 24px 16px;
        max-height: 85vh;
    }
    
    .detail-row {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .chart-container {
        height: 250px;
    }
    
    .calendar-bottom-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
}

@media (max-width: 480px) {
    .main-content {
        padding: 16px;
    }
    
    h2 {
        font-size: 1.3rem;
        margin-bottom: 16px;
    }
    
    h3 {
        font-size: 0.9rem;
    }
    
    .btn {
        padding: 8px 16px;
        font-size: 0.85rem;
    }
    
    .btn-sm {
        padding: 6px 10px;
        font-size: 0.75rem;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .calendar-header {
        padding: 8px 4px;
        font-size: 0.7rem;
    }
    
    .calendar-day {
        min-height: 60px;
    }
    
    .toast {
        bottom: 20px;
        right: 20px;
        left: 20px;
        text-align: center;
    }
}
</style>
</head>
<body>

<div class="mobile-header">
    <div class="brand">Nomadtika<span>Rotation</span></div>
    <button class="menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
</div>

<div class="mobile-overlay" id="mobileOverlay" onclick="toggleMobileMenu()"></div>

<div class="app-container">
    <div class="sidebar" id="sidebar">
        <div>
            <div class="brand">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#009B77" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                Nomadtika<span>Rotation</span>
            </div>
            <div class="nav-menu">
                <button class="nav-item active" onclick="switchTab('jobs')">
                    <span>üìù</span> Job Management
                </button>
                <button class="nav-item locked" id="navRotacion" onclick="switchTab('rotation')">
                    <span>‚ö°</span> Rotation
                </button>
                <button class="nav-item" onclick="switchTab('calendar')">
                    <span>üìÖ</span> Calendar
                </button>
                <button class="nav-item" onclick="switchTab('statistics')">
                    <span>üìä</span> Statistics
                </button>
            </div>
        </div>
        <div style="font-size:0.75rem; color:var(--text-light);">
            v4.6 - Skill Filter<br>&copy; 2026
        </div>
    </div>

    <div class="main-content">
        
        <div id="panel-jobs" class="panel active">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                <h2>Job Management</h2>
            </div>
            
            <div class="card">
                <h3>New Job</h3>
                
                <div class="priority-toggle-container">
                    <input type="checkbox" id="jobPriorityToggle" style="width:20px; height:20px; accent-color: #000;">
                    <label for="jobPriorityToggle" class="priority-toggle-label">Direct Priority Assignment (Nomadtika Priority)</label>
                </div>

                <div class="form-grid">
                    <div class="form-group" id="prioritySelectGroup" style="display:none; grid-column: 1 / -1; background:#000; padding:10px; border-radius:6px; color:#fff;">
                        <label style="color:#fff;">Select Installer (Direct Assign)</label>
                        <select id="priorityInstaller" style="width:100%; border:1px solid #333;">
                            <option value="">Select an installer...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Client *</label>
                        <input type="text" id="jobClient" placeholder="Full name">
                    </div>
                    <div class="form-group">
                        <label>Address *</label>
                        <input type="text" id="jobAddress" placeholder="Site address">
                    </div>
                    <div class="form-group full">
                        <label>Material Type * <span style="font-weight:400; color:var(--text-light)">(Search or select)</span></label>
                        <div class="material-search-container">
                            <input type="text" id="materialSearch" class="material-search-input" placeholder="Search material..." autocomplete="off">
                            <span class="material-search-icon">üîç</span>
                            <div class="material-dropdown" id="materialDropdown"></div>
                        </div>
                        <input type="hidden" id="selectedMaterial">
                        <span class="error-message" id="materialError" style="display:none;">Please select a material type</span>
                    </div>
                    <div class="form-group">
                        <label>Start Date *</label>
                        <input type="date" id="jobDate">
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="jobEndDate">
                        <span class="error-message" id="endDateError" style="display:none;">End date cannot be before start date</span>
                    </div>
                    <div class="form-group full">
                        <label>Helper / Assistant</label>
                        <input type="text" id="jobOutsider" placeholder="Name of the helper (optional)">
                    </div>
                    <div class="form-group full">
                        <label>WBQ Rate (1-10) <span style="font-weight:400; color:var(--text-light)">(Optional)</span></label>
                        <input type="number" id="jobWBQRate" min="1" max="10" step="1" placeholder="Rate from 1 to 10">
                        <span class="error-message" id="wbqError" style="display:none;">Rate must be between 1 and 10</span>
                    </div>
                    <div class="form-group full">
                        <label>Attach File (PDF/IMG)</label>
                        <div class="file-upload-wrapper" id="dropzone">
                            <input type="file" id="jobFile" style="display:none" accept=".pdf,.jpg,.jpeg,.png,.gif">
                            <span id="dropText">Click to attach work order</span>
                            <div id="fileName" class="file-name"></div>
                        </div>
                    </div>
                    <div class="form-group full">
                        <label>Notes</label>
                        <textarea id="jobNotes" rows="2" placeholder="Special instructions, additional details..."></textarea>
                    </div>
                </div>
                <div style="margin-top:20px; display:flex; gap:10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" id="btnSaveJob">Save Job</button>
                    <button class="btn btn-outline" id="btnClearJob">Clear</button>
                </div>
            </div>

            <div class="search-filter-section">
                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search by client, address, material...">
                </div>
                <div class="filters-row">
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select id="filterStatus" class="filter-select">
                            <option value="">All</option>
                            <option value="Pending">Pending</option>
                            <option value="Assigned">Assigned</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Material Category</label>
                        <select id="filterMaterialCategory" class="filter-select">
                            <option value="">All</option>
                            <option value="Wall">Wall Acoustic</option>
                            <option value="Ceiling">Ceiling Acoustic</option>
                            <option value="Screen">Screen Acoustic</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Date From</label>
                        <input type="date" id="filterDateFrom" class="date-input">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Date To</label>
                        <input type="date" id="filterDateTo" class="date-input">
                    </div>
                    <button class="clear-filters-btn" id="btnClearFilters">‚úï Clear Filters</button>
                </div>
                <div class="results-count" id="resultsCount">Showing 0 jobs</div>
            </div>

            <h3>Jobs List</h3>
            <div id="jobsList"></div>
        </div>

        <div id="panel-rotation" class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap: wrap; gap: 12px;">
                <h2>Active Rotation</h2>
                <div style="background:#E5E7EB; padding:8px 16px; border-radius:20px; font-weight:600;">
                    Assigning: <span id="activeJobClient" style="color:var(--accent)">...</span>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:24px;">
                <div>
                    <div class="installer-card">
                        <div style="text-transform:uppercase; font-size:0.8rem; letter-spacing:0.1em; opacity:0.7;">Current Turn</div>
                        <div class="installer-name" id="assignName">Daniel</div>
                        <div class="installer-meta">
                            Priority <span id="assignPriority">P1</span> ‚Ä¢ Global Job #<span id="workBadge">1</span>
                        </div>
                        
                        <div id="replacementBadge" class="replacement-alert" style="display:none">
                            <span id="replacementText"></span>
                        </div>

                        <div style="display:flex; gap:16px; width:100%; max-width:400px;">
                            <button class="btn btn-success" style="flex:1; padding:16px;" id="btnAccept">‚úì Accept</button>
                            <button class="btn btn-danger" style="flex:1; padding:16px;" id="btnReject">‚úó Reject</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3>Token Status</h3>
                    <div id="installersList"></div>
                </div>
            </div>
        </div>

        <div id="panel-calendar" class="panel">
            <div class="calendar-controls">
                <button class="btn btn-outline btn-sm" id="btnPrevMonth">‚Üê Previous</button>
                <div class="calendar-month" id="calendarMonth">January 2026</div>
                <button class="btn btn-outline btn-sm" id="btnNextMonth">Next ‚Üí</button>
            </div>

            <div class="calendar-grid" id="calendarGrid">
                <div class="calendar-header">Sun</div>
                <div class="calendar-header">Mon</div>
                <div class="calendar-header">Tue</div>
                <div class="calendar-header">Wed</div>
                <div class="calendar-header">Thu</div>
                <div class="calendar-header">Fri</div>
                <div class="calendar-header">Sat</div>
            </div>

            <div class="calendar-bottom-grid">
                <div class="card">
                    <h3 style="color:var(--text-light)">Pending Jobs (To Assign)</h3>
                    <div id="upcomingPendingJobs"></div>
                </div>
                <div class="card">
                    <h3 style="color:var(--accent)">Upcoming Assigned Jobs</h3>
                    <div id="upcomingAssignedJobs"></div>
                </div>
            </div>
        </div>

        <div id="panel-statistics" class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap: wrap; gap: 12px;">
                <h2>Statistics</h2>
                <button class="btn btn-outline btn-sm" id="btnExportExcel">‚¨á Export Excel</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statTotalJobs">0</div>
                    <div class="stat-label">Total Jobs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statPending">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statAssigned">0</div>
                    <div class="stat-label">Assigned</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statAcceptRate">0%</div>
                    <div class="stat-label">Acceptance Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statAvgWBQ">-</div>
                    <div class="stat-label">Avg WBQ Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statRatedJobs">0</div>
                    <div class="stat-label">Rated Jobs</div>
                </div>
            </div>

            <div class="card">
                <h3>Performance Comparison by Installer</h3>
                <div class="filters-container" id="chartFilters"></div>
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
                <div style="text-align:center; font-size:0.8rem; color:var(--text-light); margin-top:10px;">
                    <span style="color:#10B981">‚óè</span> Personal YES &nbsp;
                    <span style="color:#009B77">‚óè</span> Replacement YES &nbsp;
                    <span style="color:#EF4444">‚óè</span> Personal NO &nbsp;
                    <span style="color:#991B1B">‚óè</span> Replacement NO &nbsp;
                    <span style="color:#000000; font-weight:bold;">‚óè</span> Nomadtika Priority
                </div>
            </div>
            
            <div class="card">
                <h3>Performance Matrix (Quality vs. Commitment)</h3>
                <p style="font-size:0.8rem; color:var(--text-light); margin-bottom:10px;">
                    Eje Y: Calidad (WBQ) | Eje X: Compromiso (% Aceptaci√≥n)
                </p>
                <div class="chart-container">
                    <canvas id="performanceScatterChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header-flex">
                    <h3>Distribution by Material</h3>
                    <select id="materialDistFilter" class="chart-select" onchange="updateCharts()">
                        <option value="All">All Categories</option>
                        <option value="Wall">Wall Acoustic</option>
                        <option value="Ceiling">Ceiling Acoustic</option>
                        <option value="Screen">Screen Acoustic</option>
                    </select>
                </div>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="materialCategoryChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>Acceptance Rate by Installer</h3>
                <div class="chart-container">
                    <canvas id="acceptanceChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>Average WBQ Rate by Installer</h3>
                <div class="chart-container">
                    <canvas id="wbqInstallerChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header-flex">
                    <h3>Installer Skill Profile (Avg Score by Material)</h3>
                    <div style="display:flex; gap:10px;">
                        <select id="skillInstallerSelect" class="chart-select" onchange="updateSkillChart()">
                            </select>
                        <select id="skillCategorySelect" class="chart-select" onchange="updateSkillChart()">
                            <option value="All">All Categories</option>
                            <option value="Wall">Wall Acoustic</option>
                            <option value="Ceiling">Ceiling Acoustic</option>
                            <option value="Screen">Screen Acoustic</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="skillChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header-flex">
                    <h3>Average WBQ Rate by Material</h3>
                    <select id="materialWBQFilter" class="chart-select" onchange="updateCharts()">
                        <option value="All">All Categories</option>
                        <option value="Wall">Wall Acoustic</option>
                        <option value="Ceiling">Ceiling Acoustic</option>
                        <option value="Screen">Screen Acoustic</option>
                    </select>
                </div>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="wbqMaterialChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>WBQ Rate Trends Over Time</h3>
                <div class="time-filter-container">
                    <button class="time-filter-btn active" data-period="weekly">Weekly</button>
                    <button class="time-filter-btn" data-period="monthly">Monthly</button>
                </div>
                <div class="chart-container">
                    <canvas id="wbqTrendChart"></canvas>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="modal-overlay" id="detailModal">
    <div class="modal">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items: center;">
            <h3>Job Details</h3>
            <button onclick="closeModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; padding: 4px 8px;">&times;</button>
        </div>
        <div class="edit-mode-toggle">
            <button class="btn btn-danger btn-sm" id="btnEmergency" style="display:none;">üö® Emergency Reassign</button>
            <button class="btn btn-outline btn-sm" id="btnEditMode">‚úèÔ∏è Edit</button>
            <button class="btn btn-success btn-sm" id="btnSaveEdit" style="display:none;">üíæ Save Changes</button>
            <button class="btn btn-outline btn-sm" id="btnCancelEdit" style="display:none;">‚úï Cancel</button>
        </div>
        
        <div id="emergencySection" class="reassign-section">
            <h4 style="color:#991B1B; margin-bottom:10px;">üö® Emergency Reassign (Priority Protocol)</h4>
            <p style="font-size:0.85rem; color:#666; margin-bottom:12px;">This will penalize the current installer and assign the job to the new selected person as a PRIORITY job.</p>
            <div style="display:flex; gap:10px;">
                <select id="emergencySelect" style="flex:1; padding:8px;">
                    <option value="">Select replacement...</option>
                </select>
                <button class="btn btn-danger btn-sm" onclick="confirmEmergencyReassign()">Confirm Reassign</button>
                <button class="btn btn-outline btn-sm" onclick="toggleEmergencySection()">Cancel</button>
            </div>
        </div>

        <div id="modalContent"></div>
        <div style="margin-top:24px; text-align:right;">
            <button class="btn btn-primary" onclick="closeModal()">Close</button>
        </div>
    </div>
</div>

<div class="toast" id="toast">Notification</div>

<script>
const MATERIALS = {
    'Wall': [
        'Frontier‚Ñ¢',
        'Composition¬Æ',
        'Groove Duet¬Æ',
        'Groove‚Ñ¢ Panel',
        'Mirage‚Ñ¢ Textured Panel',
        'Embrace‚Ñ¢ Wall System',
        'ReForm‚Ñ¢',
        'Lanes‚Ñ¢',
        'Cube‚Ñ¢',
        'Acoustic Timber‚Ñ¢',
        'Quietspace¬Æ Panel',
        'Vertiface¬Æ',
        'Composition¬Æ Peel \'n\' Stick Tiles',
        '3D Tiles',
        'Horizon‚Ñ¢'
    ],
    'Ceiling': [
        'Frontier‚Ñ¢',
        'Groove Duet¬Æ',
        'Groove‚Ñ¢ Panel',
        'Grid Ceiling Tiles',
        'ReForm‚Ñ¢',
        'Horizon‚Ñ¢',
        'Accent Ceiling Tiles',
        'Quietspace¬Æ Panel',
        'Acoustic Timber‚Ñ¢',
        '3D Ceiling Tiles',
        'Lattice‚Ñ¢',
        'Cube‚Ñ¢'
    ],
    'Screen': [
        'Cascade‚Ñ¢',
        'Vicinity‚Ñ¢ Workstation Screens',
        'Cove‚Ñ¢'
    ]
};

const INSTALLERS = [
  {id:1,name:'Daniel',priority:'P1'},
  {id:2,name:'Jimmy',priority:'P2'},
  {id:3,name:'Cristian',priority:'P3'},
  {id:4,name:'Bob',priority:'P4'},
  {id:5,name:'Kafw',priority:'P5'},
  {id:6,name:'Kyle',priority:'P6'}
];

const INSTALLER_COLORS = {
    'Daniel': '#3B82F6',   // Azul
    'Jimmy': '#EF4444',    // Rojo
    'Cristian': '#10B981', // Verde
    'Bob': '#F59E0B',      // Naranja
    'Kafw': '#8B5CF6',     // Violeta
    'Kyle': '#EC4899',     // Rosa
    'Pending': '#9CA3AF',  // Gris (Sin asignar)
    'Default': '#6366F1'   // Indigo (Outsiders/Otros)
};

function populateInstallerDropdowns() {
    const opts = INSTALLERS.map(i => `<option value="${i.name}">${i.name}</option>`).join('');
    document.getElementById('priorityInstaller').innerHTML = '<option value="">Select an installer...</option>' + opts;
    document.getElementById('emergencySelect').innerHTML = '<option value="">Select replacement...</option>' + opts;
    // POPULATE SKILL FILTER
    document.getElementById('skillInstallerSelect').innerHTML = opts;
}

let rCounter = 0;
let state = {
    currentWork: 1,
    tracking: INSTALLERS.map(i=>({...i, replacements:[], usedReplacements:[]})),
    history: [],
    offer: {installerId:1, isReplacement:false, logic:null, originalInstaller:null, alreadyAsked:[], replacementNumber:null},
    jobs: [],
    activeJobId: null
};

let visibleInstallers = new Set(INSTALLERS.map(i=>i.id));

let filterState = {
    searchQuery: '',
    status: '',
    materialCategory: '',
    dateFrom: '',
    dateTo: ''
};

let currentCalendarDate = new Date();
let editMode = false;
let currentEditingJobId = null;
let selectedMaterialType = '';
let editFileAction = null;
let editNewFile = null;
let wbqTrendPeriod = 'weekly';

// PRIORITY TOGGLE LOGIC
const priorityToggle = document.getElementById('jobPriorityToggle');
const priorityGroup = document.getElementById('prioritySelectGroup');

priorityToggle.addEventListener('change', (e) => {
    if(e.target.checked) {
        priorityGroup.style.display = 'block';
    } else {
        priorityGroup.style.display = 'none';
        document.getElementById('priorityInstaller').value = '';
    }
});

function renderMaterialDropdown(searchTerm = '') {
    const dropdown = document.getElementById('materialDropdown');
    const term = searchTerm.toLowerCase();
    let html = '';
    
    Object.keys(MATERIALS).forEach(category => {
        const filteredMaterials = MATERIALS[category].filter(m => 
            m.toLowerCase().includes(term)
        );
        
        if (filteredMaterials.length > 0) {
            html += `<div class="material-category">${category} Acoustic</div>`;
            filteredMaterials.forEach(material => {
                const fullName = `${category} - ${material}`;
                const isSelected = selectedMaterialType === fullName;
                html += `
                    <div class="material-option ${isSelected ? 'selected' : ''}" 
                         data-material="${fullName}" 
                         onclick="selectMaterial('${fullName.replace(/'/g, "\\'")}')">
                        ${material}
                    </div>
                `;
            });
        }
    });
    
    if (html === '') {
        html = '<div style="padding:12px; text-align:center; color:var(--text-light);">No materials found</div>';
    }
    
    dropdown.innerHTML = html;
}

window.selectMaterial = function(materialName) {
    selectedMaterialType = materialName;
    document.getElementById('selectedMaterial').value = materialName;
    document.getElementById('materialSearch').value = materialName;
    document.getElementById('materialDropdown').classList.remove('show');
    hideMaterialError();
}

function showMaterialError() {
    const errorEl = document.getElementById('materialError');
    const searchInput = document.getElementById('materialSearch');
    errorEl.style.display = 'block';
    searchInput.classList.add('error');
}

function hideMaterialError() {
    const errorEl = document.getElementById('materialError');
    const searchInput = document.getElementById('materialSearch');
    errorEl.style.display = 'none';
    searchInput.classList.remove('error');
}

function getMaterialCategory(materialName) {
    if (!materialName) return '';
    return materialName.split(' - ')[0];
}

function getMaterialBadgeClass(category) {
    if (category === 'Wall') return 'material-wall';
    if (category === 'Ceiling') return 'material-ceiling';
    if (category === 'Screen') return 'material-screen';
    return '';
}

document.getElementById('materialSearch').addEventListener('input', (e) => {
    const value = e.target.value;
    selectedMaterialType = '';
    document.getElementById('selectedMaterial').value = '';
    renderMaterialDropdown(value);
    document.getElementById('materialDropdown').classList.add('show');
});

document.getElementById('materialSearch').addEventListener('focus', () => {
    renderMaterialDropdown(document.getElementById('materialSearch').value);
    document.getElementById('materialDropdown').classList.add('show');
});

document.addEventListener('click', (e) => {
    const container = document.querySelector('.material-search-container');
    if (container && !container.contains(e.target)) {
        document.getElementById('materialDropdown').classList.remove('show');
    }
});

renderMaterialDropdown();
populateInstallerDropdowns(); 

function toggleMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobileOverlay');
    sidebar.classList.toggle('mobile-open');
    overlay.classList.toggle('active');
}

document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
        if(window.innerWidth <= 768) {
            toggleMobileMenu();
        }
    });
});

function switchTab(tabId) {
    if(tabId === 'rotation' && state.activeJobId === null) {
        showToast("‚ö†Ô∏è Please select a job first");
        return;
    }
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
    document.getElementById('panel-'+tabId).classList.add('active');
    
    const navItems = document.querySelectorAll('.nav-item');
    if(tabId==='jobs') navItems[0].classList.add('active');
    if(tabId==='rotation') navItems[1].classList.add('active');
    if(tabId==='calendar') {
        navItems[2].classList.add('active');
        renderCalendar();
        renderUpcomingJobs();
    }
    if(tabId==='statistics') {
        navItems[3].classList.add('active');
        updateStats();
        renderFilters();
        updateCharts();
        updateSkillChart(); // Init New Chart
    }
}

function updateRotacionLockUI() {
    const btn = document.getElementById('navRotacion');
    if(state.activeJobId !== null) {
        btn.classList.remove('locked');
        btn.innerHTML = '<span>‚ö°</span> Assigning...';
    } else {
        btn.classList.add('locked');
        btn.innerHTML = '<span>‚ö°</span> Rotation';
    }
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'),3000);
}

function validateJobForm() {
    const client = document.getElementById('jobClient').value.trim();
    const address = document.getElementById('jobAddress').value.trim();
    const material = document.getElementById('selectedMaterial').value;
    const date = document.getElementById('jobDate').value;
    
    if(priorityToggle.checked) {
        if(!document.getElementById('priorityInstaller').value) return false;
    }
    return client && address && material && date;
}

function validateDateRange(startDate, endDate) {
    if(!startDate || !endDate) return true;
    return endDate >= startDate;
}

function validateWBQRate(rate) {
    if (!rate) return true;
    const num = parseInt(rate);
    return num >= 1 && num <= 10;
}

function showDateError() {
    document.getElementById('endDateError').style.display = 'block';
    document.getElementById('jobEndDate').classList.add('error');
}

function hideDateError() {
    document.getElementById('endDateError').style.display = 'none';
    document.getElementById('jobEndDate').classList.remove('error');
}

function showWBQError() {
    document.getElementById('wbqError').style.display = 'block';
    document.getElementById('jobWBQRate').classList.add('error');
}

function hideWBQError() {
    document.getElementById('wbqError').style.display = 'none';
    document.getElementById('jobWBQRate').classList.remove('error');
}

document.getElementById('jobDate').addEventListener('change', () => {
    const startDate = document.getElementById('jobDate').value;
    const endDate = document.getElementById('jobEndDate').value;
    if(validateDateRange(startDate, endDate)) hideDateError(); else showDateError();
});

document.getElementById('jobEndDate').addEventListener('change', () => {
    const startDate = document.getElementById('jobDate').value;
    const endDate = document.getElementById('jobEndDate').value;
    if(validateDateRange(startDate, endDate)) hideDateError(); else showDateError();
});

document.getElementById('jobWBQRate').addEventListener('input', (e) => {
    const value = e.target.value;
    if(validateWBQRate(value)) hideWBQError(); else showWBQError();
});

function getById(id){ return state.tracking.find(i=>i.id===id) }
function getCurrentInstaller(){ return ((state.currentWork-1)%6)+1 }

function findLogicA(asked=[]){
  const avail = state.tracking.filter(i=>i.replacements.length>0 && !asked.includes(i.id));
  if(!avail.length) return null;
  avail.sort((a,b)=>Math.min(...a.replacements)-Math.min(...b.replacements));
  return avail[0];
}
function findLogicB(origId, asked=[]){
  const idx = INSTALLERS.findIndex(i=>i.id===origId);
  for(let i=1;i<INSTALLERS.length;i++){
    const id = INSTALLERS[(idx+i)%INSTALLERS.length].id;
    if(!asked.includes(id)) return getById(id);
  }
  return null;
}
function offerReplacement(origId, asked=[]){
  let rep = findLogicA(asked);
  if(rep){
    state.offer={installerId:rep.id, isReplacement:true, logic:'A', originalInstaller:origId, alreadyAsked:asked, replacementNumber:rep.replacements[0]};
    renderRotation(); return;
  }
  rep = findLogicB(origId, asked);
  if(rep){
    state.offer={installerId:rep.id, isReplacement:true, logic:'B', originalInstaller:origId, alreadyAsked:asked, replacementNumber:null};
    renderRotation();
  }
}

function handleAccept(){
  const ins = getById(state.offer.installerId);
  let note = '';
  
  if(state.offer.isReplacement){
    if(state.offer.logic==='A'){
      const used = ins.replacements.shift();
      ins.usedReplacements.push(used);
      note = `Replacement A (R${state.offer.replacementNumber})`;
    } else { note = `Replacement B`; }
    state.history.push({
      work:state.currentWork, installerId:ins.id, installerName:ins.name,
      response:'YES', type:'REPLACEMENT', notes: note, jobId: state.activeJobId
    });
  } else {
    rCounter++;
    ins.replacements.push(rCounter);
    note = `Normal (R${rCounter})`;
    state.history.push({
      work:state.currentWork, installerId:ins.id, installerName:ins.name,
      response:'YES', type:'NORMAL', notes: note, jobId: state.activeJobId
    });
  }

  const jobIndex = state.jobs.findIndex(j=>j.id===state.activeJobId);
  if(jobIndex > -1) {
      state.jobs[jobIndex].status = 'Assigned';
      state.jobs[jobIndex].assignedTo = ins.name;
      state.jobs[jobIndex].assignedDate = new Date().toLocaleDateString();
  }

  state.currentWork++;
  state.offer={installerId:getCurrentInstaller(), isReplacement:false, logic:null, originalInstaller:null, alreadyAsked:[], replacementNumber:null};
  state.activeJobId = null;
  updateRotacionLockUI(); renderJobs(); switchTab('jobs');
  showToast(`‚úÖ Job assigned to ${ins.name}`);
}

function handleReject(){
  const ins = getById(state.offer.installerId);
  const origRejector = state.offer.originalInstaller || ins.id;
  const asked = [...state.offer.alreadyAsked, ins.id];
  
  state.history.push({
      work:state.currentWork, installerId:ins.id, installerName:ins.name,
      response:'NO', type: state.offer.isReplacement ? 'REPLACEMENT' : 'NORMAL',
      notes: 'Rejected', jobId: state.activeJobId
  });

  if(state.offer.isReplacement && state.offer.logic==='A'){
      const used = ins.replacements.shift();
      ins.usedReplacements.push(used);
  }
  offerReplacement(origRejector, asked);
}

document.getElementById('btnAccept').addEventListener('click', handleAccept);
document.getElementById('btnReject').addEventListener('click', handleReject);

function renderRotation() {
    const ins = getById(state.offer.installerId);
    const job = state.jobs.find(j => j.id === state.activeJobId);
    document.getElementById('activeJobClient').textContent = job ? job.client : '...';
    document.getElementById('assignName').textContent = ins.name;
    document.getElementById('assignPriority').textContent = ins.priority;
    document.getElementById('workBadge').textContent = state.currentWork;

    const rb = document.getElementById('replacementBadge');
    if(state.offer.isReplacement) {
        rb.style.display = 'block';
        const orig = getById(state.offer.originalInstaller);
        document.getElementById('replacementText').textContent = 
            state.offer.logic === 'A' 
            ? `‚ö† Replaces ${orig.name} (Uses Token R${state.offer.replacementNumber})`
            : `‚Ñπ Next available after ${orig.name} (Logic B)`;
    } else { rb.style.display = 'none'; }

    document.getElementById('installersList').innerHTML = state.tracking.map(i => {
        const has = i.replacements.length > 0;
        return `
        <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee;">
            <div style="font-weight:600; ${i.id===ins.id ? 'color:var(--accent)':''}">${i.name}</div>
            <div style="font-family:monospace; font-size:0.8rem; background:${has?'#ECFDF5':'#F3F4F6'}; color:${has?'#047857':'#9CA3AF'}; padding:2px 8px; border-radius:4px;">
                ${has ? i.replacements.join(', ') : '0'}
            </div>
        </div>`;
    }).join('');
}

const fileInput = document.getElementById('jobFile');
const dropzone = document.getElementById('dropzone');
let pendingFile = null;

dropzone.addEventListener('click', ()=>fileInput.click());
fileInput.addEventListener('change', (e)=>{
    if(e.target.files[0]) {
        pendingFile = e.target.files[0];
        document.getElementById('fileName').textContent = "üìÑ " + pendingFile.name;
    }
});

document.getElementById('btnSaveJob').addEventListener('click', ()=>{
    if(!validateJobForm()) {
        if(!document.getElementById('selectedMaterial').value) {
            showMaterialError();
        }
        showToast("‚ö†Ô∏è Please complete required fields");
        return;
    }

    const startDate = document.getElementById('jobDate').value;
    const endDate = document.getElementById('jobEndDate').value;
    
    if(!validateDateRange(startDate, endDate)) {
        showToast("‚ö†Ô∏è End date cannot be before start date");
        showDateError();
        return;
    }

    const wbqRate = document.getElementById('jobWBQRate').value;
    if(!validateWBQRate(wbqRate)) {
        showToast("‚ö†Ô∏è WBQ Rate must be between 1 and 10");
        showWBQError();
        return;
    }

    const client = document.getElementById('jobClient').value.trim();
    const addr = document.getElementById('jobAddress').value.trim();
    const outsider = document.getElementById('jobOutsider').value.trim();
    const materialType = document.getElementById('selectedMaterial').value;
    const isPriority = priorityToggle.checked;
    const priorityAssignee = document.getElementById('priorityInstaller').value;

    let fileUrl = null;
    let fileName = null;
    if(pendingFile) {
        fileUrl = URL.createObjectURL(pendingFile);
        fileName = pendingFile.name;
    }

    const newJob = {
        id: Date.now(), 
        client: client, 
        address: addr,
        materialType: materialType,
        date: startDate,
        endDate: endDate || null,
        outsider: outsider || null,
        wbqRate: wbqRate ? parseInt(wbqRate) : null,
        notes: document.getElementById('jobNotes').value,
        fileName: fileName,
        fileUrl: fileUrl,
        status: isPriority ? 'Assigned' : 'Pending', 
        assignedTo: isPriority ? priorityAssignee : null,
        isPriority: isPriority,
        rotationHistory: []
    };

    if(isPriority) {
        const insObj = INSTALLERS.find(i => i.name === priorityAssignee);
        if(insObj) {
            state.history.push({
                work: state.currentWork,
                installerId: insObj.id,
                installerName: insObj.name,
                response: 'YES',
                type: 'PRIORITY',
                notes: 'Direct Assignment (Nomadtika Priority)',
                jobId: newJob.id
            });
        }
    }

    state.jobs.push(newJob);
    renderJobs();
    document.getElementById('btnClearJob').click();
    showToast(isPriority ? "‚úÖ Priority Job Assigned" : "‚úÖ Job Saved");
});

document.getElementById('btnClearJob').addEventListener('click', ()=>{
    document.getElementById('jobClient').value = '';
    document.getElementById('jobAddress').value = '';
    document.getElementById('jobNotes').value = '';
    document.getElementById('jobEndDate').value = '';
    document.getElementById('jobOutsider').value = '';
    document.getElementById('jobWBQRate').value = '';
    document.getElementById('materialSearch').value = '';
    document.getElementById('selectedMaterial').value = '';
    document.getElementById('fileName').textContent = '';
    document.getElementById('priorityInstaller').value = '';
    priorityToggle.checked = false;
    priorityGroup.style.display = 'none';
    selectedMaterialType = '';
    hideDateError();
    hideMaterialError();
    hideWBQError();
    pendingFile = null;
});

document.getElementById('searchInput').addEventListener('input', (e) => { filterState.searchQuery = e.target.value; renderJobs(); });
document.getElementById('filterStatus').addEventListener('change', (e) => { filterState.status = e.target.value; renderJobs(); });
document.getElementById('filterMaterialCategory').addEventListener('change', (e) => { filterState.materialCategory = e.target.value; renderJobs(); });
document.getElementById('filterDateFrom').addEventListener('change', (e) => { filterState.dateFrom = e.target.value; renderJobs(); });
document.getElementById('filterDateTo').addEventListener('change', (e) => { filterState.dateTo = e.target.value; renderJobs(); });

function getFilteredJobs() {
    let filtered = [...state.jobs];
    if (filterState.searchQuery) {
        const query = filterState.searchQuery.toLowerCase();
        filtered = filtered.filter(job => 
            job.client.toLowerCase().includes(query) ||
            job.address.toLowerCase().includes(query) ||
            (job.assignedTo && job.assignedTo.toLowerCase().includes(query)) ||
            (job.materialType && job.materialType.toLowerCase().includes(query))
        );
    }
    if (filterState.status) filtered = filtered.filter(job => job.status === filterState.status);
    if (filterState.materialCategory) filtered = filtered.filter(job => job.materialType && getMaterialCategory(job.materialType) === filterState.materialCategory);
    if (filterState.dateFrom) filtered = filtered.filter(job => job.date && job.date >= filterState.dateFrom);
    if (filterState.dateTo) filtered = filtered.filter(job => job.date && job.date <= filterState.dateTo);
    return filtered;
}

function updateResultsCount(count) {
    document.getElementById('resultsCount').textContent = `Showing ${count} job${count !== 1 ? 's' : ''}`;
}

document.getElementById('btnClearFilters').addEventListener('click', () => {
    filterState = { searchQuery: '', status: '', materialCategory: '', dateFrom: '', dateTo: '' };
    document.getElementById('searchInput').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterMaterialCategory').value = '';
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';
    renderJobs();
    showToast('üîÑ Filters cleared');
});

function renderJobs() {
    const list = document.getElementById('jobsList');
    const filteredJobs = getFilteredJobs();
    const today = new Date().toISOString().split('T')[0];
    
    updateResultsCount(filteredJobs.length);
    
    if(!filteredJobs.length) {
        if(state.jobs.length === 0) {
            list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-text">No jobs registered</div><div class="empty-state-subtext">Start by creating a new job above</div></div>';
        } else {
            list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><div class="empty-state-text">No results found</div><div class="empty-state-subtext">Try adjusting your search filters</div></div>';
        }
        return;
    }
    
    list.innerHTML = filteredJobs.slice().reverse().map(job => {
        const materialCategory = getMaterialCategory(job.materialType);
        const badgeClass = getMaterialBadgeClass(materialCategory);
        const isComplete = (job.endDate && job.endDate < today) || (!job.endDate && job.date < today);
        
        return `
        <div class="job-item">
            <div class="job-item-content">
                <div style="font-weight:700; color:var(--primary)">${job.client}</div>
                <div style="font-size:0.85rem; color:var(--text-light)">
                    ${job.address} ‚Ä¢ ${job.date||'-'}${job.endDate ? ' ‚Üí ' + job.endDate : ''}
                </div>
                <div style="margin-top: 4px;">
                    <span class="job-status ${job.status==='Pending'?'status-pending':'status-assigned'}">${job.status}</span>
                    ${isComplete ? '<span class="job-status status-complete">COMPLETED</span>' : ''}
                    ${job.isPriority ? '<span class="job-status status-priority">PRIORITY</span>' : ''}
                    ${job.materialType ? `<span class="material-badge ${badgeClass}">${job.materialType}</span>` : ''}
                    ${job.outsider ? '<span class="outsider-badge">HELPER: ' + job.outsider + '</span>' : ''}
                </div>
                ${job.assignedTo ? `<div class="assigned-worker">üë§ Assigned to: ${job.assignedTo}${job.outsider ? ' + ' + job.outsider : ''}${job.wbqRate ? ` ‚Ä¢ ‚≠ê ${job.wbqRate}/10` : ''}</div>` : ''}
            </div>
            <div class="job-item-actions">
                 ${job.status === 'Pending' ? `<button class="btn btn-primary btn-sm" onclick="startRotation(${job.id})">‚Üí Assign</button>` : `<button class="btn btn-outline btn-sm" onclick="viewDetails(${job.id})">üìã Details</button>`}
            </div>
        </div>
    `}).join('');
}

window.startRotation = function(id) {
    state.activeJobId = id;
    updateRotacionLockUI();
    switchTab('rotation');
    renderRotation();
}

window.viewDetails = function(id) {
    currentEditingJobId = id;
    editMode = false;
    editFileAction = null;
    editNewFile = null;
    document.getElementById('emergencySection').classList.remove('show');
    renderJobDetails(id);
    document.getElementById('detailModal').style.display = 'flex';
}

window.toggleEmergencySection = function() {
    document.getElementById('emergencySection').classList.toggle('show');
}

window.confirmEmergencyReassign = function() {
    const newInstallerName = document.getElementById('emergencySelect').value;
    if(!newInstallerName) { showToast("‚ö†Ô∏è Select a replacement installer"); return; }
    
    const job = state.jobs.find(j => j.id === currentEditingJobId);
    const prevHistory = state.history.find(h => h.jobId === currentEditingJobId && h.response === 'YES' && h.installerName === job.assignedTo);
    
    if(prevHistory) {
        prevHistory.response = 'NO';
        prevHistory.notes += ' (Failed to attend - Emergency Reassign)';
        if (prevHistory.type === 'NORMAL') {
            const match = prevHistory.notes.match(/R(\d+)/);
            if (match) {
                const tokenToRemove = parseInt(match[1]);
                const prevInstaller = state.tracking.find(i => i.id === prevHistory.installerId);
                if (prevInstaller) {
                    const tokenIndex = prevInstaller.replacements.indexOf(tokenToRemove);
                    if (tokenIndex > -1) {
                        prevInstaller.replacements.splice(tokenIndex, 1);
                        showToast(`üö´ Token R${tokenToRemove} removed from ${prevInstaller.name}`);
                    }
                }
            }
        }
    }
    
    const newInsObj = INSTALLERS.find(i => i.name === newInstallerName);
    if(newInsObj) {
        state.history.push({
            work: state.currentWork, installerId: newInsObj.id, installerName: newInsObj.name,
            response: 'YES', type: 'PRIORITY', notes: `Emergency Cover for ${job.assignedTo}`, jobId: job.id
        });
    }
    
    job.assignedTo = newInstallerName;
    job.isPriority = true;
    
    toggleEmergencySection();
    closeModal();
    renderJobs();
    updateStats();
    showToast(`üö® Job reassigned to ${newInstallerName} (Priority)`);
}

document.getElementById('btnEmergency').addEventListener('click', toggleEmergencySection);

function renderJobDetails(id) {
    const job = state.jobs.find(j => j.id === id);
    if(!job) return;
    
    const jobHistory = state.history.filter(h => h.jobId === id);
    document.getElementById('btnEditMode').style.display = editMode ? 'none' : 'inline-flex';
    document.getElementById('btnSaveEdit').style.display = editMode ? 'inline-flex' : 'none';
    document.getElementById('btnCancelEdit').style.display = editMode ? 'inline-flex' : 'none';
    document.getElementById('btnEmergency').style.display = (job.status === 'Assigned' && !editMode) ? 'inline-flex' : 'none';
    
    const materialCategory = getMaterialCategory(job.materialType);
    const badgeClass = getMaterialBadgeClass(materialCategory);
    
    let fileHtml = '';
    // (Existing file rendering logic omitted for brevity, reusing previous implementation)
    if (editMode) {
        if (job.fileUrl && job.fileName && editFileAction !== 'remove') {
            fileHtml = `<div class="detail-row full"><div class="detail-label">Attached File</div><div class="file-edit-container"><div class="file-current"><span class="file-current-name">üìÑ ${job.fileName}</span><div class="file-current-actions"><a href="${job.fileUrl}" download="${job.fileName}" class="btn btn-success btn-sm" style="text-decoration:none;">‚¨á Download</a><button class="btn btn-danger btn-sm" onclick="removeEditFile()">üóëÔ∏è Remove</button></div></div>${editNewFile ? `<div style="padding:8px 12px; background:#ECFDF5; border:1px solid #BBF7D0; border-radius:6px; color:#047857; font-size:0.85rem;">‚úì New file will replace current: ${editNewFile.name}</div>` : `<div class="file-upload-edit" id="editFileUpload"><input type="file" id="editFile" style="display:none" accept=".pdf,.jpg,.jpeg,.png,.gif"><span>Click to replace with new file</span></div>`}</div></div>`;
        } else if (editFileAction === 'remove') {
            fileHtml = `<div class="detail-row full"><div class="detail-label">Attached File</div><div class="file-edit-container"><div class="file-removed-indicator">üóëÔ∏è File will be removed when you save changes</div><button class="btn btn-outline btn-sm" onclick="undoRemoveFile()" style="width:100%;">‚Ü∂ Undo Remove</button></div></div>`;
        } else {
            fileHtml = `<div class="detail-row full"><div class="detail-label">Attached File</div>${editNewFile ? `<div style="padding:8px 12px; background:#ECFDF5; border:1px solid #BBF7D0; border-radius:6px; color:#047857; font-size:0.85rem;">‚úì New file selected: ${editNewFile.name}</div>` : `<div class="file-upload-edit" id="editFileUpload"><input type="file" id="editFile" style="display:none" accept=".pdf,.jpg,.jpeg,.png,.gif"><span>Click to attach file</span></div>`}</div>`;
        }
    } else {
        if(job.fileUrl && job.fileName) {
            fileHtml = `<div class="detail-row full" style="background:#F0FDF4; padding:12px; border-radius:8px; border:1px solid #BBF7D0;"><div class="detail-label" style="margin-bottom:8px;">Attached File</div><div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 8px;"><span style="font-weight:600; font-size:0.9rem;">üìÑ ${job.fileName}</span><a href="${job.fileUrl}" download="${job.fileName}" class="btn btn-success btn-sm" style="text-decoration:none;">‚¨á Download</a></div></div>`;
        } else {
            fileHtml = `<div class="detail-row full"><div class="detail-label">File</div><div class="detail-content" style="color:#999;">No attachment</div></div>`;
        }
    }

    const html = `
        <div class="detail-row"><div class="detail-field"><div class="detail-label">Client</div>${editMode ? `<input type="text" class="detail-input" id="edit-client" value="${job.client}">` : `<div class="detail-content">${job.client}</div>`}</div><div class="detail-field"><div class="detail-label">Address</div>${editMode ? `<input type="text" class="detail-input" id="edit-address" value="${job.address}">` : `<div class="detail-content">${job.address}</div>`}</div></div>
        <div class="detail-row full"><div class="detail-field"><div class="detail-label">Material Type</div>${editMode ? `<div class="material-search-container"><input type="text" id="editMaterialSearch" class="material-search-input" placeholder="Search material..." autocomplete="off" value="${job.materialType}"><span class="material-search-icon">üîç</span><div class="material-dropdown" id="editMaterialDropdown"></div></div><input type="hidden" id="editSelectedMaterial" value="${job.materialType}">` : `<div class="detail-content"><span class="material-badge ${badgeClass}">${job.materialType}</span></div>`}</div></div>
        <div class="detail-row"><div class="detail-field"><div class="detail-label">Start Date</div>${editMode ? `<input type="date" class="detail-input" id="edit-date" value="${job.date}">` : `<div class="detail-content">${job.date || '-'}</div>`}</div><div class="detail-field"><div class="detail-label">End Date</div>${editMode ? `<input type="date" class="detail-input" id="edit-enddate" value="${job.endDate||''}">` : `<div class="detail-content">${job.endDate || '-'}</div>`}</div></div>
        <div class="detail-row"><div class="detail-field"><div class="detail-label">Helper / Assistant</div>${editMode ? `<input type="text" class="detail-input" id="edit-outsider" value="${job.outsider||''}" placeholder="Helper name">` : `<div class="detail-content">${job.outsider ? 'üë§ ' + job.outsider : '-'}</div>`}</div><div class="detail-field"><div class="detail-label">WBQ Rate (1-10)</div>${editMode ? `<input type="number" class="detail-input" id="edit-wbqrate" min="1" max="10" step="1" value="${job.wbqRate||''}" placeholder="1-10">` : `<div class="detail-content">${job.wbqRate ? '‚≠ê ' + job.wbqRate + '/10' : '-'}</div>`}</div></div>
        <div class="detail-row"><div class="detail-field"><div class="detail-label">Assigned To</div><div class="detail-content" style="color:var(--accent); font-weight:700;">${job.assignedTo || '-'} ${job.isPriority ? '<span class="job-status status-priority" style="margin-left:8px; font-size:0.7rem;">PRIORITY</span>' : ''}</div></div><div class="detail-field"><div class="detail-label">Status</div><div class="detail-content"><span class="job-status ${job.status==='Pending'?'status-pending':'status-assigned'}">${job.status}</span></div></div></div>
        ${fileHtml}
        <div class="detail-row full"><div class="detail-label">Notes</div>${editMode ? `<textarea class="detail-input" id="edit-notes" rows="3" style="resize: vertical;">${job.notes||''}</textarea>` : `<div class="detail-content" style="font-size:0.9rem;">${job.notes || '-'}</div>`}</div>
        ${jobHistory.length > 0 ? `<div class="detail-row full"><div class="detail-label">Rotation History</div><div class="timeline-container">${jobHistory.map(h => `<div class="timeline-item"><div class="timeline-dot"></div><div style="position:relative; width:100%;">${jobHistory.indexOf(h) < jobHistory.length - 1 ? '<div class="timeline-line"></div>' : ''}<div class="timeline-content"><div class="timeline-header"><div class="timeline-installer">${h.installerName}</div><span class="timeline-response ${h.response === 'YES' ? 'response-yes' : 'response-no'}">${h.response === 'YES' ? '‚úì ACCEPTED' : '‚úó REJECTED'}</span></div><div style="font-size:0.85rem; color:var(--text-light);">${h.type === 'PRIORITY' ? '<strong>[PRIORITY]</strong> ' : ''}${h.notes}</div></div></div></div>`).join('')}</div></div>` : ''}
    `;
    document.getElementById('modalContent').innerHTML = html;
    
    if (editMode) {
        // ... (Edit mode event listeners logic remains same as before, simplified for length limit) ...
        const editFileUpload = document.getElementById('editFileUpload');
        const editFileInput = document.getElementById('editFile');
        if (editFileUpload && editFileInput) {
            editFileUpload.addEventListener('click', () => editFileInput.click());
            editFileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    editNewFile = e.target.files[0];
                    editFileAction = 'replace';
                    renderJobDetails(currentEditingJobId);
                }
            });
        }
        let editSelectedMaterial = job.materialType;
        const editMaterialSearch = document.getElementById('editMaterialSearch');
        const editMaterialDropdown = document.getElementById('editMaterialDropdown');
        function renderEditMaterialDropdown(searchTerm = '') {
            const term = searchTerm.toLowerCase();
            let html = '';
            Object.keys(MATERIALS).forEach(category => {
                const filteredMaterials = MATERIALS[category].filter(m => m.toLowerCase().includes(term));
                if (filteredMaterials.length > 0) {
                    html += `<div class="material-category">${category} Acoustic</div>`;
                    filteredMaterials.forEach(material => {
                        const fullName = `${category} - ${material}`;
                        const isSelected = editSelectedMaterial === fullName;
                        html += `<div class="material-option ${isSelected ? 'selected' : ''}" data-material="${fullName}">${material}</div>`;
                    });
                }
            });
            if (html === '') html = '<div style="padding:12px; text-align:center; color:var(--text-light);">No materials found</div>';
            editMaterialDropdown.innerHTML = html;
            editMaterialDropdown.querySelectorAll('.material-option').forEach(option => {
                option.addEventListener('click', () => {
                    const materialName = option.getAttribute('data-material');
                    editSelectedMaterial = materialName;
                    document.getElementById('editSelectedMaterial').value = materialName;
                    editMaterialSearch.value = materialName;
                    editMaterialDropdown.classList.remove('show');
                });
            });
        }
        editMaterialSearch.addEventListener('input', (e) => {
            const value = e.target.value;
            editSelectedMaterial = '';
            document.getElementById('editSelectedMaterial').value = '';
            renderEditMaterialDropdown(value);
            editMaterialDropdown.classList.add('show');
        });
        editMaterialSearch.addEventListener('focus', () => {
            renderEditMaterialDropdown(editMaterialSearch.value);
            editMaterialDropdown.classList.add('show');
        });
        renderEditMaterialDropdown();
    }
}

window.removeEditFile = function() { editFileAction = 'remove'; editNewFile = null; renderJobDetails(currentEditingJobId); }
window.undoRemoveFile = function() { editFileAction = null; editNewFile = null; renderJobDetails(currentEditingJobId); }
document.getElementById('btnEditMode').addEventListener('click', () => { editMode = true; editFileAction = null; editNewFile = null; renderJobDetails(currentEditingJobId); });
document.getElementById('btnCancelEdit').addEventListener('click', () => { editMode = false; editFileAction = null; editNewFile = null; document.getElementById('emergencySection').classList.remove('show'); renderJobDetails(currentEditingJobId); });

document.getElementById('btnSaveEdit').addEventListener('click', () => {
    const job = state.jobs.find(j => j.id === currentEditingJobId);
    if(!job) return;
    const newStartDate = document.getElementById('edit-date').value;
    const newEndDate = document.getElementById('edit-enddate').value;
    if(!validateDateRange(newStartDate, newEndDate)) { showToast("‚ö†Ô∏è End date cannot be before start date"); return; }
    const newWBQRate = document.getElementById('edit-wbqrate').value;
    if(!validateWBQRate(newWBQRate)) { showToast("‚ö†Ô∏è WBQ Rate must be between 1 and 10"); return; }
    
    job.client = document.getElementById('edit-client').value.trim();
    job.address = document.getElementById('edit-address').value.trim();
    job.materialType = document.getElementById('editSelectedMaterial').value;
    job.date = newStartDate;
    job.endDate = newEndDate || null;
    job.outsider = document.getElementById('edit-outsider').value.trim() || null;
    job.wbqRate = newWBQRate ? parseInt(newWBQRate) : null;
    job.notes = document.getElementById('edit-notes').value;
    
    if (editFileAction === 'remove') { job.fileName = null; job.fileUrl = null; } 
    else if (editNewFile) { job.fileUrl = URL.createObjectURL(editNewFile); job.fileName = editNewFile.name; }
    
    editMode = false;
    renderJobDetails(currentEditingJobId);
    renderJobs();
    showToast("‚úÖ Changes saved");
});

window.closeModal = function() { 
    document.getElementById('detailModal').style.display = 'none';
    editMode = false; editFileAction = null; editNewFile = null; currentEditingJobId = null;
    document.getElementById('emergencySection').classList.remove('show');
}

function renderCalendar() {
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June','July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const grid = document.getElementById('calendarGrid');
    const headers = grid.querySelectorAll('.calendar-header');
    grid.innerHTML = '';
    headers.forEach(h => grid.appendChild(h));
    for(let i = 0; i < firstDay; i++) {
        const empty = document.createElement('div'); empty.className = 'calendar-day'; empty.style.opacity = '0.3'; grid.appendChild(empty);
    }
    for(let day = 1; day <= daysInMonth; day++) {
        const dayEl = document.createElement('div'); dayEl.className = 'calendar-day';
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const jobsOnDay = state.jobs.filter(j => {
            if(!j.date) return false;
            if(j.endDate) return dateStr >= j.date && dateStr <= j.endDate;
            return j.date === dateStr;
        });
        dayEl.innerHTML = `<div class="calendar-day-number">${day}</div>${jobsOnDay.map(j => {
            let bgColor = INSTALLER_COLORS['Pending'];
            if(j.isPriority) bgColor = '#000000';
            else if(j.status === 'Assigned' && j.assignedTo) bgColor = INSTALLER_COLORS[j.assignedTo] || INSTALLER_COLORS['Default'];
            const displayText = j.assignedTo ? `${j.assignedTo}: ${j.client.substring(0, 10)}` : j.client.substring(0, 15);
            return `<div class="calendar-event" onclick="viewDetails(${j.id})" title="${j.client} - ${j.assignedTo || 'Pending'}" style="background-color: ${bgColor}; border-left: 3px solid rgba(255,255,255,0.2);">${displayText}${displayText.length < (j.client.length) ? '...' : ''}</div>`;
        }).join('')}`;
        grid.appendChild(dayEl);
    }
}

function renderUpcomingJobs() {
    const today = new Date().toISOString().split('T')[0];
    const pendingJobs = state.jobs.filter(j => j.status === 'Pending').sort((a, b) => a.date.localeCompare(b.date));
    const assignedJobs = state.jobs.filter(j => j.status === 'Assigned' && j.date >= today).sort((a, b) => a.date.localeCompare(b.date)).slice(0, 10);
    
    const pendingContainer = document.getElementById('upcomingPendingJobs');
    if(pendingJobs.length === 0) pendingContainer.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-light);">No pending jobs</div>';
    else pendingContainer.innerHTML = pendingJobs.map(j => `<div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid var(--border); gap: 12px; flex-wrap: wrap; background: #FFF7ED; border-left: 4px solid #C2410C;"><div style="flex: 1; min-width: 150px;"><div style="font-weight:700; color:var(--primary)">${j.client}</div><div style="font-size:0.85rem; color:var(--text-light)">üìÖ ${j.date} ‚Ä¢ ${j.address}</div></div><button class="btn btn-primary btn-sm" onclick="startRotation(${j.id})">‚Üí Assign</button></div>`).join('');

    const assignedContainer = document.getElementById('upcomingAssignedJobs');
    if(assignedJobs.length === 0) assignedContainer.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-light);">No upcoming assigned jobs</div>';
    else assignedContainer.innerHTML = assignedJobs.map(j => {
        let bgColor = INSTALLER_COLORS[j.assignedTo] || INSTALLER_COLORS['Default'];
        if(j.isPriority) bgColor = '#000000';
        return `<div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid var(--border); gap: 12px; flex-wrap: wrap; border-left: 4px solid ${bgColor};"><div style="flex: 1; min-width: 150px;"><div style="font-weight:700; color:var(--primary)">${j.client}</div><div style="font-size:0.85rem; color:var(--text-light)"><span style="color:${bgColor}; font-weight:700;">${j.assignedTo}</span> ‚Ä¢ ${j.date} ${j.isPriority ? '<span style="background:#000; color:#fff; padding:2px 6px; border-radius:10px; font-size:0.65rem; margin-left:6px;">PRIORITY</span>' : ''}</div></div><button class="btn btn-outline btn-sm" onclick="viewDetails(${j.id})">View</button></div>`;
    }).join('');
}

document.getElementById('btnPrevMonth').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); });
document.getElementById('btnNextMonth').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(); });

function updateStats() {
    const total = state.jobs.length;
    const pending = state.jobs.filter(j => j.status === 'Pending').length;
    const assigned = state.jobs.filter(j => j.status === 'Assigned').length;
    const totalResponses = state.history.length;
    const acceptedResponses = state.history.filter(h => h.response === 'YES').length;
    const acceptRate = totalResponses > 0 ? Math.round((acceptedResponses / totalResponses) * 100) : 0;
    const ratedJobs = state.jobs.filter(j => j.wbqRate !== null && j.wbqRate !== undefined);
    const totalWBQ = ratedJobs.reduce((sum, j) => sum + j.wbqRate, 0);
    const avgWBQ = ratedJobs.length > 0 ? (totalWBQ / ratedJobs.length).toFixed(1) : '-';
    
    document.getElementById('statTotalJobs').textContent = total;
    document.getElementById('statPending').textContent = pending;
    document.getElementById('statAssigned').textContent = assigned;
    document.getElementById('statAcceptRate').textContent = acceptRate + '%';
    document.getElementById('statAvgWBQ').textContent = avgWBQ === '-' ? avgWBQ : avgWBQ + '/10';
    document.getElementById('statRatedJobs').textContent = ratedJobs.length;
}

let chartInstance = null;
let materialCategoryChartInstance = null;
let acceptanceChartInstance = null;
let wbqInstallerChartInstance = null;
let wbqMaterialChartInstance = null;
let wbqTrendChartInstance = null;
let performanceScatterChartInstance = null;
let skillChartInstance = null; // NEW CHART INSTANCE

function renderFilters() {
    const container = document.getElementById('chartFilters');
    container.innerHTML = INSTALLERS.map(ins => {
        const isActive = visibleInstallers.has(ins.id);
        return `<div class="filter-chip ${isActive?'active':''}" onclick="toggleFilter(${ins.id})"><span class="chip-dot" style="background:${isActive?'#fff':'#999'}"></span>${ins.name}</div>`;
    }).join('');
}

window.toggleFilter = function(id) {
    if(visibleInstallers.has(id)) { if(visibleInstallers.size > 1) visibleInstallers.delete(id); } else { visibleInstallers.add(id); }
    renderFilters();
    updateCharts();
}

// NEW: FUNCTION TO UPDATE SKILL CHART
function updateSkillChart() {
    const ctx = document.getElementById('skillChart').getContext('2d');
    if(skillChartInstance) skillChartInstance.destroy();
    
    const selectedInstallerName = document.getElementById('skillInstallerSelect').value;
    const selectedCategory = document.getElementById('skillCategorySelect').value;
    
    if(!selectedInstallerName) return; 
    
    const installerColor = INSTALLER_COLORS[selectedInstallerName] || '#666';
    
    // Calculate average scores per material
    const materialScores = {};
    const materialCounts = {};
    
    state.jobs.forEach(j => {
        if(j.assignedTo === selectedInstallerName && j.wbqRate && j.materialType) {
            
            // Check Category Filter
            const cat = getMaterialCategory(j.materialType);
            if(selectedCategory !== 'All' && cat !== selectedCategory) return;

            const name = j.materialType.includes(' - ') ? j.materialType.split(' - ')[1] : j.materialType;
            
            if(!materialScores[name]) { materialScores[name] = 0; materialCounts[name] = 0; }
            materialScores[name] += j.wbqRate;
            materialCounts[name]++;
        }
    });
    
    // Prepare data arrays
    const labels = Object.keys(materialScores);
    const data = labels.map(name => (materialScores[name] / materialCounts[name]).toFixed(1));
    
    // Sort by Score descending
    const zipped = labels.map((label, i) => ({ label, score: data[i] }));
    zipped.sort((a, b) => b.score - a.score);
    
    const sortedLabels = zipped.map(z => z.label);
    const sortedData = zipped.map(z => z.score);

    if(sortedLabels.length === 0) {
        // Empty state for chart
        skillChartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels: ['No Rated Jobs'], datasets: [{ label: 'Score', data: [0], backgroundColor: '#eee' }] },
            options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false }
        });
        return;
    }

    skillChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sortedLabels,
            datasets: [{
                label: `Avg WBQ (${selectedInstallerName})`,
                data: sortedData,
                backgroundColor: installerColor,
                borderColor: installerColor,
                borderWidth: 1,
                barPercentage: 0.6
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { beginAtZero: true, max: 10, title: { display: true, text: 'WBQ Score (1-10)' } }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.raw}/10`;
                        }
                    }
                }
            }
        }
    });
}

function updateCharts() {
    const ctx = document.getElementById('mainChart').getContext('2d');
    if(chartInstance) chartInstance.destroy();

    const filteredInstallers = INSTALLERS.filter(i => visibleInstallers.has(i.id));
    const labels = filteredInstallers.map(i => i.name);
    const dataPersonalSI = [], dataReemplazoSI = [], dataPersonalNO = [], dataReemplazoNO = [], dataPrioritySI = [];

    filteredInstallers.forEach(ins => {
        const events = state.history.filter(h => h.installerId === ins.id);
        dataPersonalSI.push(events.filter(h => h.response==='YES' && h.type==='NORMAL').length);
        dataReemplazoSI.push(events.filter(h => h.response==='YES' && h.type==='REPLACEMENT').length);
        dataPersonalNO.push(events.filter(h => h.response==='NO' && h.type==='NORMAL').length);
        dataReemplazoNO.push(events.filter(h => h.response==='NO' && h.type==='REPLACEMENT').length);
        dataPrioritySI.push(events.filter(h => h.response==='YES' && h.type==='PRIORITY').length);
    });

    chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { label: 'Personal YES', data: dataPersonalSI, backgroundColor: '#10B981' },
                { label: 'Replacement YES', data: dataReemplazoSI, backgroundColor: '#009B77' },
                { label: 'Personal NO', data: dataPersonalNO, backgroundColor: '#EF4444' },
                { label: 'Replacement NO', data: dataReemplazoNO, backgroundColor: '#991B1B' },
                { label: 'Priority YES', data: dataPrioritySI, backgroundColor: '#000000' }
            ]
        },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, grid: { color: '#f3f4f6' } }, y: { stacked: true, grid: { display: false } } }, plugins: { legend: { display: false } } }
    });

    // --- MATERIAL DISTRIBUTION CHART WITH FILTER ---
    const ctx2 = document.getElementById('materialCategoryChart').getContext('2d');
    if(materialCategoryChartInstance) materialCategoryChartInstance.destroy();

    const distFilter = document.getElementById('materialDistFilter').value;
    let distLabels = [], distData = [], distColors = [];

    if (distFilter === 'All') {
        const counts = { Wall: 0, Ceiling: 0, Screen: 0 };
        state.jobs.forEach(j => { const c = getMaterialCategory(j.materialType); if(c && counts.hasOwnProperty(c)) counts[c]++; });
        distLabels = ['Wall Acoustic', 'Ceiling Acoustic', 'Screen Acoustic'];
        distData = [counts.Wall, counts.Ceiling, counts.Screen];
        distColors = ['#3B82F6', '#F59E0B', '#8B5CF6'];
    } else {
        const materialCounts = {};
        state.jobs.forEach(j => {
            const cat = getMaterialCategory(j.materialType);
            if (cat === distFilter) {
                const subName = j.materialType.split(' - ')[1] || j.materialType;
                materialCounts[subName] = (materialCounts[subName] || 0) + 1;
            }
        });
        distLabels = Object.keys(materialCounts);
        distData = Object.values(materialCounts);
        distColors = distLabels.map((_, i) => `hsl(${ (i * 360) / distLabels.length }, 70%, 50%)`);
        
        if(distLabels.length === 0) { distLabels = ['No Data']; distData = [0]; distColors = ['#ddd']; }
    }

    materialCategoryChartInstance = new Chart(ctx2, {
        type: 'doughnut',
        data: { labels: distLabels, datasets: [{ data: distData, backgroundColor: distColors }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });

    const ctx3 = document.getElementById('acceptanceChart').getContext('2d');
    if(acceptanceChartInstance) acceptanceChartInstance.destroy();
    const acceptanceData = INSTALLERS.map(ins => {
        const events = state.history.filter(h => h.installerId === ins.id);
        const accepted = events.filter(h => h.response === 'YES').length;
        return events.length > 0 ? Math.round((accepted / events.length) * 100) : 0;
    });
    acceptanceChartInstance = new Chart(ctx3, {
        type: 'bar',
        data: { labels: INSTALLERS.map(i => i.name), datasets: [{ label: 'Acceptance Rate (%)', data: acceptanceData, backgroundColor: INSTALLERS.map(i => INSTALLER_COLORS[i.name]) }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } }, plugins: { legend: { display: false } } }
    });

    const ctx4 = document.getElementById('wbqInstallerChart').getContext('2d');
    if(wbqInstallerChartInstance) wbqInstallerChartInstance.destroy();
    const wbqByInstaller = INSTALLERS.map(ins => {
        const jobs = state.jobs.filter(j => j.assignedTo === ins.name && j.wbqRate);
        if (jobs.length === 0) return 0;
        return (jobs.reduce((s, j) => s + j.wbqRate, 0) / jobs.length).toFixed(1);
    });
    wbqInstallerChartInstance = new Chart(ctx4, {
        type: 'bar',
        data: { labels: INSTALLERS.map(i => i.name), datasets: [{ label: 'Average WBQ Rate', data: wbqByInstaller, backgroundColor: INSTALLERS.map(i => INSTALLER_COLORS[i.name]) }] },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, max: 10, ticks: { callback: v => v + '/10' } } }, plugins: { legend: { display: false } } }
    });

    // --- WBQ MATERIAL CHART WITH FILTER ---
    const ctx5 = document.getElementById('wbqMaterialChart').getContext('2d');
    if(wbqMaterialChartInstance) wbqMaterialChartInstance.destroy();

    const wbqFilter = document.getElementById('materialWBQFilter').value;
    let wbqLabels = [], wbqData = [], wbqColors = [];

    if (wbqFilter === 'All') {
        const wbqCats = { Wall: [], Ceiling: [], Screen: [] };
        state.jobs.forEach(j => { if(j.wbqRate) { const c = getMaterialCategory(j.materialType); if(c && wbqCats[c]) wbqCats[c].push(j.wbqRate); }});
        wbqLabels = ['Wall Acoustic', 'Ceiling Acoustic', 'Screen Acoustic'];
        wbqData = [
            wbqCats.Wall.length ? (wbqCats.Wall.reduce((a,b)=>a+b,0)/wbqCats.Wall.length).toFixed(1) : 0,
            wbqCats.Ceiling.length ? (wbqCats.Ceiling.reduce((a,b)=>a+b,0)/wbqCats.Ceiling.length).toFixed(1) : 0,
            wbqCats.Screen.length ? (wbqCats.Screen.reduce((a,b)=>a+b,0)/wbqCats.Screen.length).toFixed(1) : 0
        ];
        wbqColors = ['#3B82F6', '#F59E0B', '#8B5CF6'];
    } else {
        const matScores = {};
        state.jobs.forEach(j => {
            if (j.wbqRate) {
                const cat = getMaterialCategory(j.materialType);
                if (cat === wbqFilter) {
                    const subName = j.materialType.split(' - ')[1] || j.materialType;
                    if(!matScores[subName]) matScores[subName] = [];
                    matScores[subName].push(j.wbqRate);
                }
            }
        });
        wbqLabels = Object.keys(matScores);
        wbqData = wbqLabels.map(l => (matScores[l].reduce((a,b)=>a+b,0)/matScores[l].length).toFixed(1));
        wbqColors = wbqLabels.map((_, i) => `hsl(${ (i * 360) / wbqLabels.length }, 70%, 50%)`);
        
        if(wbqLabels.length === 0) { wbqLabels = ['No Data']; wbqData = [0]; wbqColors = ['#ddd']; }
    }

    wbqMaterialChartInstance = new Chart(ctx5, {
        type: 'doughnut',
        data: { labels: wbqLabels, datasets: [{ data: wbqData, backgroundColor: wbqColors }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: c => c.label + ': ' + c.parsed + '/10' } } } }
    });
    
    // SCATTER PLOT
    const ctxScatter = document.getElementById('performanceScatterChart').getContext('2d');
    if(performanceScatterChartInstance) performanceScatterChartInstance.destroy();
    const scatterData = INSTALLERS.map(ins => {
        const events = state.history.filter(h => h.installerId === ins.id);
        const accepted = events.filter(h => h.response === 'YES').length;
        const rateX = events.length > 0 ? Math.round((accepted / events.length) * 100) : 0;
        const jobs = state.jobs.filter(j => j.assignedTo === ins.name && j.wbqRate);
        const avgY = jobs.length > 0 ? (jobs.reduce((s, j) => s + j.wbqRate, 0) / jobs.length).toFixed(1) : 0;
        const r = 5 + (jobs.length * 1.5); 
        return { x: rateX, y: avgY, installerName: ins.name, r: r < 5 ? 5 : (r > 20 ? 20 : r) };
    });
    performanceScatterChartInstance = new Chart(ctxScatter, {
        type: 'bubble',
        data: { datasets: scatterData.map(d => ({ label: d.installerName, data: [{x: d.x, y: d.y, r: d.r}], backgroundColor: INSTALLER_COLORS[d.installerName], borderColor: '#fff', borderWidth: 1 })) },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Acceptance Rate (%)' }, min: 0, max: 105 }, y: { title: { display: true, text: 'Avg WBQ Score (1-10)' }, min: 0, max: 11 } }, plugins: { tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.raw.y}/10 WBQ (${c.raw.x}% Accept)` } }, legend: { position: 'bottom' } } }
    });

    updateWBQTrendChart();
    updateSkillChart(); // Call new chart function
}

function updateWBQTrendChart() {
    const ctx6 = document.getElementById('wbqTrendChart').getContext('2d');
    if(wbqTrendChartInstance) wbqTrendChartInstance.destroy();
    const ratedJobs = state.jobs.filter(j => j.wbqRate && j.date).sort((a, b) => a.date.localeCompare(b.date));
    if (ratedJobs.length === 0) { wbqTrendChartInstance = new Chart(ctx6, { type: 'line', data: { labels: [], datasets: [{ label: 'Average WBQ Rate', data: [], borderColor: '#009B77', backgroundColor: 'rgba(0, 155, 119, 0.1)', tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 10 } } } }); return; }

    const groupedData = {};
    ratedJobs.forEach(job => {
        const date = new Date(job.date);
        let key;
        if (wbqTrendPeriod === 'weekly') {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            const weekNum = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
            const weekString = weekNum < 10 ? '0' + weekNum : weekNum;
            key = `${date.getFullYear()}-W${weekString}`;
        } else {
            const monthNum = date.getMonth() + 1;
            const monthString = monthNum < 10 ? '0' + monthNum : monthNum;
            key = `${date.getFullYear()}-${monthString}`;
        }
        if (!groupedData[key]) groupedData[key] = [];
        groupedData[key].push(job.wbqRate);
    });

    const labels = Object.keys(groupedData).sort();
    const data = labels.map(label => { const rates = groupedData[label]; return (rates.reduce((a, b) => a + b, 0) / rates.length).toFixed(1); });

    wbqTrendChartInstance = new Chart(ctx6, {
        type: 'line',
        data: { labels: labels, datasets: [{ label: 'Average WBQ Rate', data: data, borderColor: '#009B77', backgroundColor: 'rgba(0, 155, 119, 0.1)', tension: 0.4, fill: true }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 10, ticks: { callback: v => v + '/10' } } }, plugins: { tooltip: { callbacks: { label: c => 'Avg: ' + c.parsed.y + '/10' } } } }
    });
}

document.querySelectorAll('.time-filter-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        document.querySelectorAll('.time-filter-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        wbqTrendPeriod = e.target.getAttribute('data-period');
        updateWBQTrendChart();
    });
});

document.getElementById('btnExportExcel').addEventListener('click', () => {
    if(typeof XLSX === 'undefined') { showToast("Error: Excel library not loaded"); return; }
    const wb = XLSX.utils.book_new();
    const jobsData = state.jobs.map(j => ({ ID: j.id, Client: j.client, Address: j.address, MaterialType: j.materialType || '', StartDate: j.date, EndDate: j.endDate || '', Helper: j.outsider || '', WBQRate: j.wbqRate || '', Status: j.status, AssignedTo: j.assignedTo || '', Notes: j.notes }));
    const ws1 = XLSX.utils.json_to_sheet(jobsData);
    XLSX.utils.book_append_sheet(wb, ws1, "Jobs");
    const histData = state.history.map(h => ({ GlobalJob: h.work, Installer: h.installerName, Response: h.response, Type: h.type, Notes: h.notes, JobID: h.jobId }));
    const ws2 = XLSX.utils.json_to_sheet(histData);
    XLSX.utils.book_append_sheet(wb, ws2, "History");
    XLSX.writeFile(wb, "Nomadtika_Report.xlsx");
    showToast("üìä Excel downloaded");
});

renderJobs();
</script>
</body>
</html>